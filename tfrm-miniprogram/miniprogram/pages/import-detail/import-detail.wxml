<view class="detail-container">

  <view wx:if="{{loading}}" class="loading-state">

    <text class="loading-text">åŠ è½½ä¸­...</text>

  </view>



  <view wx:elif="{{task.status === 'parsing'}}" class="parsing-state">

    <view class="parsing-icon">ğŸ¤–</view>

    <text class="parsing-title">AIæ­£åœ¨è§£æä¸­...</text>

    <text class="parsing-desc">è¯·ç¨å€™ï¼Œé€šå¸¸éœ€è¦10-30ç§’</text>

    <view class="progress-dots">

      <view class="dot"></view>

      <view class="dot"></view>

      <view class="dot"></view>

    </view>

  </view>



  <view wx:elif="{{task.status === 'failed'}}" class="error-state">

    <text class="error-icon">âŒ</text>

    <text class="error-title">è§£æå¤±è´¥</text>

    <text class="error-message">{{task.error_message}}</text>

    <button class="btn-back" bindtap="handleBack">è¿”å›</button>

  </view>



  <view wx:elif="{{task.status === 'parsed'}}" class="parsed-content">

    <view class="status-banner">

      <text class="banner-icon">âœ…</text>

      <view class="banner-text">

        <text class="banner-title">AIè§£æå®Œæˆ</text>

        <text class="banner-desc">ç½®ä¿¡åº¦ï¼š{{confidencePercent}}%</text>

      </view>

    </view>



    <view class="sku-type-section">

      <view class="section-title">
        èµ„æºç±»å‹
        <text wx:if="{{typeAutoDetected && typeConfidence >= 0.8}}" class="ai-badge">ğŸ¤– AIè¯†åˆ«</text>
      </view>

      <picker mode="selector" range="{{skuTypes}}" range-key="label" value="{{selectedTypeIndex}}" bindchange="onSkuTypeChange" disabled="{{typeAutoDetected}}">

        <view class="picker-field {{typeAutoDetected ? 'disabled' : ''}}">

          <text>{{skuTypes[selectedTypeIndex].label}}</text>

          <text class="picker-arrow" wx:if="{{!typeAutoDetected}}">â–¼</text>
          <text class="lock-icon" wx:else>ğŸ”’</text>

        </view>

      </picker>
      
      <text wx:if="{{typeAutoDetected}}" class="type-hint">AIå·²è‡ªåŠ¨è¯†åˆ«ç±»å‹ï¼ˆç½®ä¿¡åº¦{{typeConfidencePercent}}%ï¼‰ï¼Œå¦‚éœ€ä¿®æ”¹è¯·è”ç³»ç®¡ç†å‘˜</text>

    </view>

    <!-- åˆ†å±‚ç»“æ„é¢„è§ˆ -->
    <view wx:if="{{structuredData && showStructuredPreview}}" class="structured-preview-section">
      <view class="section-header">
        <text class="section-title">åˆ†å±‚ç»“æ„é¢„è§ˆ</text>
        <text class="toggle-btn" bindtap="toggleStructuredPreview">æ”¶èµ·</text>
      </view>

      <!-- æ ¸å¿ƒä¿¡æ¯å¡ç‰‡ -->
      <view class="preview-card core-info">
        <text class="card-name">{{structuredData.name}}</text>
        <view class="card-meta">
          <view class="type-badge type-{{structuredData.type}}">{{structuredData.typeLabel}}</view>
          <text class="location">ğŸ“ {{structuredData.location}}</text>
        </view>
      </view>

      <!-- ä»·æ ¼ä¿¡æ¯ -->
      <view class="preview-card price-info">
        <view class="price-row">
          <view class="price-item">
            <text class="price-label">æˆæœ¬ä»·</text>
            <text class="price-value cost">Â¥{{structuredData.costPrice}}</text>
          </view>
          <view class="price-item">
            <text class="price-label">é”€å”®ä»·</text>
            <text class="price-value sales">Â¥{{structuredData.salesPrice}}</text>
          </view>
          <view class="price-item">
            <text class="price-label">æ¯›åˆ©ç‡</text>
            <text class="price-value margin">{{structuredData.profitMargin}}%</text>
          </view>
        </view>
      </view>

      <!-- äº®ç‚¹åˆ—è¡¨ -->
      <view wx:if="{{structuredData.highlights.length > 0}}" class="preview-card highlights">
        <text class="card-title">âœ¨ äº®ç‚¹æå–</text>
        <view class="highlight-list">
          <view wx:for="{{structuredData.highlights}}" wx:key="index" class="highlight-item">
            <text class="bullet">â€¢</text>
            <text class="highlight-text">{{item}}</text>
          </view>
        </view>
      </view>

      <!-- è¡Œä¸šä¸“å±å‚æ•° -->
      <view wx:if="{{structuredData.categoryAttributes}}" class="preview-card category-attrs">
        <text class="card-title">ğŸ¯ è¡Œä¸šä¸“å±å‚æ•°</text>
        <view class="attrs-grid">
          <block wx:for="{{structuredData.categoryAttributes}}" wx:for-item="value" wx:for-index="key" wx:key="key">
            <view wx:if="{{value}}" class="attr-item">
              <text class="attr-label">{{key}}</text>
              <text class="attr-value">{{value}}</text>
            </view>
          </block>
        </view>
      </view>

      <!-- åŒ…å«/æ’é™¤é¡¹ -->
      <view class="preview-row">
        <view wx:if="{{structuredData.inclusions.length > 0}}" class="preview-card inclusions">
          <text class="card-title">âœ“ åŒ…å«å†…å®¹</text>
          <view class="item-list">
            <text wx:for="{{structuredData.inclusions}}" wx:key="index" class="item">âœ“ {{item}}</text>
          </view>
        </view>
        <view wx:if="{{structuredData.exclusions.length > 0}}" class="preview-card exclusions">
          <text class="card-title">âœ• ä¸åŒ…å«</text>
          <view class="item-list">
            <text wx:for="{{structuredData.exclusions}}" wx:key="index" class="item">âœ• {{item}}</text>
          </view>
        </view>
      </view>

      <!-- é€€æ”¹æ”¿ç­– -->
      <view class="preview-card policy">
        <text class="card-title">ğŸ“‹ é€€æ”¹æ”¿ç­–</text>
        <text class="policy-text">{{structuredData.cancellationPolicy}}</text>
      </view>

      <!-- è¯¦ç»†ä»·æ ¼è¡¨ -->
      <view wx:if="{{structuredData.pricingDetails.roomTypes.length > 0 || structuredData.pricingDetails.diningOptions.length > 0}}" class="pricing-details-section">
        <view class="section-header">
          <text class="section-title">ğŸ“Š è¯¦ç»†ä»·æ ¼è¡¨</text>
          <text class="toggle-btn" bindtap="togglePricingDetails">{{showPricingDetails ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        
        <view wx:if="{{showPricingDetails}}" class="pricing-content">
          <!-- æˆ¿å‹ä»·æ ¼è¡¨ -->
          <view wx:if="{{structuredData.pricingDetails.roomTypes.length > 0}}" class="pricing-table">
            <text class="table-title">ğŸ¨ æˆ¿å‹ä»·æ ¼</text>
            <view wx:for="{{structuredData.pricingDetails.roomTypes}}" wx:key="index" class="room-item">
              <text class="room-name">{{item.room_type_name}}</text>
              <text class="room-breakfast">{{item.include_breakfast ? 'å«æ—©' : 'ä¸å«æ—©'}}</text>
            </view>
          </view>

          <!-- é¤é¥®ä»·æ ¼è¡¨ -->
          <view wx:if="{{structuredData.pricingDetails.diningOptions.length > 0}}" class="pricing-table">
            <text class="table-title">ğŸ½ï¸ é¤é¥®ä»·æ ¼</text>
            <view wx:for="{{structuredData.pricingDetails.diningOptions}}" wx:key="index" class="dining-item">
              <text class="dining-type">{{item.meal_type}}</text>
            </view>
          </view>
        </view>
      </view>

      <!-- å®Œæ•´æå–æ•°æ® -->
      <view class="raw-data-section">
        <view class="section-header">
          <text class="section-title">ğŸ” å®Œæ•´æå–æ•°æ®</text>
          <text class="toggle-btn" bindtap="toggleRawData">{{showRawData ? 'æ”¶èµ·' : 'å±•å¼€'}}</text>
        </view>
        <view wx:if="{{showRawData}}" class="raw-data-content">
          <text class="raw-data-text">{{structuredData.rawExtracted}}</text>
        </view>
      </view>
    </view>

    <view class="fields-section">

      <view class="section-title">æå–çš„å­—æ®µ</view>

      <view class="field-list">

        <view wx:for="{{fieldList}}" wx:key="key" class="field-item">

          <view class="field-header">

            <text class="field-label">{{item.label}}</text>

            <text wx:if="{{item.hasEvidence}}" class="evidence-btn" bindtap="handleShowEvidence" data-field="{{item.key}}">

              æŸ¥çœ‹ä¾æ®

            </text>

          </view>

          <input 

            class="field-input {{item.lowConfidence ? 'low-confidence' : ''}}" 

            value="{{item.value}}" 

            bindinput="onFieldChange"

            data-field="{{item.key}}"

            placeholder="è¯·è¾“å…¥{{item.label}}"

          />

          <text wx:if="{{item.lowConfidence}}" class="confidence-warning">âš ï¸ ç½®ä¿¡åº¦è¾ƒä½ï¼Œè¯·æ£€æŸ¥</text>

        </view>

      </view>

    </view>



    <view class="action-section">

      <button class="btn-confirm" bindtap="handleConfirm" disabled="{{confirming}}">

        {{confirming ? 'ç¡®è®¤ä¸­...' : 'ç¡®è®¤å…¥åº“'}}

      </button>

    </view>

  </view>



  <view wx:elif="{{task.status === 'confirmed'}}" class="confirmed-state">

    <text class="success-icon">ğŸ‰</text>

    <text class="success-title">å·²å…¥åº“æˆåŠŸ</text>

    <text class="success-desc">SKU ID: {{skuId}}</text>

    <view class="action-buttons">

      <button class="btn-view-sku" bindtap="handleViewSku">æŸ¥çœ‹èµ„æº</button>

      <button class="btn-back-list" bindtap="handleBackToList">è¿”å›åˆ—è¡¨</button>

    </view>

  </view>

</view>



<view wx:if="{{showEvidenceModal}}" class="modal-overlay" bindtap="handleCloseEvidence">

  <view class="modal-content" catchtap="stopPropagation">

    <view class="modal-header">

      <text class="modal-title">æå–ä¾æ®</text>

      <text class="modal-close" bindtap="handleCloseEvidence">âœ•</text>

    </view>

    <view class="modal-body">

      <text class="evidence-text">{{currentEvidence}}</text>

    </view>

  </view>

</view>

